## ⚙️ Chapter 8: Cognito Authentication for Application Behind Load Balancer

In this chapter, we will configure **Amazon Cognito** as an authentication layer for our application, which is exposed through an Application Load Balancer (ALB). The ALB will use Cognito as an **OIDC (OpenID Connect)** provider, meaning users must sign in via Cognito before they can access our application.

---

### X.1 Create a Cognito User Pool

We will create a **User Pool** to store and manage our application’s users.

1. Log in to the [AWS Management Console](https://console.aws.amazon.com/).
2. Navigate to **Amazon Cognito > Create user pool**.
3. **Pool name**: `ratingo-user-pool`
4. **Attributes**:

   * Required: `email`
   * Optional: `name`
5. **Password policy**: Keep defaults or adjust per security requirements.
6. **Self-service sign-up**: Enabled (optional — disable if you want admin-only creation).
7. **MFA**: Optional or Required (based on your security needs).
8. **Email verification**: Enabled.
9. Click **Create user pool**.

---

### X.2 Create a Cognito App Client

The App Client represents the application that will interact with Cognito for authentication.

1. In your newly created User Pool, go to **App clients > Create app client**.
2. **Name**: `ratingo-app-client`
3. **Generate client secret**: **Disable** (ALB does not support client secrets).
4. Click **Create app client**.
5. Note the **App client ID** — we will use it in the ALB configuration.

---

### X.3 Create a Cognito Domain

We need a hosted authentication domain for the sign-in page.

1. In the same User Pool, go to **App integration > Domain name**.
2. Enter a unique domain prefix, e.g., `ratingo-auth`.
3. Click **Save changes**.
4. Note the full domain URL — something like:

   ```
   https://ratingo-auth.auth.us-east-1.amazoncognito.com
   ```

---

### X.4 Configure App Client Callback URLs

The ALB needs a **callback URL** to redirect users after successful login.

1. In **App client settings**, enable the following identity providers:

   * Cognito User Pool.
2. Set **Callback URL(s)**:

   * Example: `https://<your-alb-dns-name>/oauth2/idpresponse`
3. Set **Sign out URL(s)**:

   * Example: `https://<your-alb-dns-name>/`
4. Allowed OAuth Flows:

   * **Authorization code grant**
5. Allowed OAuth Scopes:

   * `email`
   * `openid`
   * `profile`
6. Click **Save changes**.

---

### X.5 Configure the ALB to Use Cognito Authentication

We will now connect the ALB listener to the Cognito User Pool.

1. Go to **EC2 > Load Balancers**.
2. Select your **Application Load Balancer**.
3. Under **Listeners**, edit the HTTPS listener.
4. Add a **Rule**:

   * **IF** Path is `/` (or leave as default for all traffic).
   * **THEN** Authenticate using Cognito.
5. Configure Cognito settings:

   * User pool: `ratingo-user-pool`
   * App client: `ratingo-app-client`
   * Domain: `ratingo-auth`
6. Add a second **Action** after authentication:

   * Forward to your target group for the application.
7. Save changes.

---

### X.6 Test Authentication Flow

1. Visit your ALB DNS name in a browser:

   ```
   https://<your-alb-dns-name>/
   ```
2. You should be redirected to the Cognito-hosted login page.
3. Sign in with a registered user.
4. You should be redirected back to your application.

---

✅ **At this point**, your application behind the ALB is protected by Cognito authentication. Only authenticated users can access it.

---

If you want, I can extend this guide with **step-by-step screenshots** and **Terraform or CloudFormation examples** so it’s fully automated — similar to how your ASG + ALB example could be turned into code.

Do you want me to add that?
