## ⚙️ Chapter 7: Auto Scaling Group (ASG) and Load Balancer (LB)

In this chapter, we will create the infrastructure to automatically scale our application using an Auto Scaling Group, fronted by an Application Load Balancer (ALB) to distribute incoming traffic. The ASG will launch EC2 instances from a custom AMI we create, and will only accept traffic from the Load Balancer.


### 7.1 Create Security Group for Load Balancer

This will allow public HTTP and HTTPS traffic.

1. Go to **EC2 > Security Groups > Create security group**.
2. **Name**: `ratingo-lb-sg`
3. **Inbound rules**:

   * Allow **HTTP (80)** from **0.0.0.0/0** (Anywhere).
   * Allow **HTTPS (443)** from **0.0.0.0/0** (Anywhere).
4. Click **Create**


### 7.2 Create Security Group for ASG Instances

We want the ASG instances to only accept traffic from the Load Balancer and Twingate.

1. Go to **EC2 > Security Groups > Create security group**.
2. **Name**: `ratingo-frontend-sg`
3. **Inbound rules**:

   * Allow **HTTP (80)** from the **Load Balancer security group** created in step **7.1**
   * Allow **SSH (22)** from the **twingate security group**
4. Click **Create**

### 7.3 Launch EC2 Instance for AMI Creation

We first create an EC2 instance where we’ll upload our application code, configure it, and create an AMI for the ASG.

1. **Log in** to the [AWS Management Console](https://console.aws.amazon.com/).

2. Go to **EC2 > Instances > Launch instances**.

3. **Name**: `ratingo-ami`

4. **AMI**: Select an appropriate OS (e.g., Ubuntu, Amazon Linux 2).

5. **Instance type**: Choose a suitable type (e.g., `t3.micro`).

6. Select the **Key pair** created in chapter 1

7. Click on the **Edit Button**  next the **Network Settings**
    * Select the **VPC** created in **chapter 1**
    * Choose any of the private subnets from the list
    * Choose **Select exisiting security group** and Attach the **asg security group** created in **step 7.2**

8. Launch the instance.


### 7.4 Add a resource for the instance to twingate

1. Login to twingate 

2. On the **Remote Network** tab, select your remote network

3. Click Create Resource

4. Provide a label eg `ami-instance`

5. Provide the **private ip address** of the instance in the address field. It should look like `10.0.0.123`

6. Grant access to this resource to Everyone, or if you have crated any groups, grant to the specific group


### 7.5 Add a resource for the instance to twingate

1. On your terminal or visual studio code, locate where you have stored your private key from **chapter 1**

2. Run the command below to connect 
    ```
    ssh -i "ratingo-keypair.pem" ubuntu@10.0.1.123
    ```
    replacing **ratingo-keypair.pem** with your private key and **10.0.1.123** with the private ip of your instance

3. Run the command below to create an directory for your app
    ```
    sudo mkdir /app
    ```

4. Download the init [script here](https://github.com/WIP25-GB/Project-Info/blob/main/deployment/init.sql)

5. Clone the [front end repository](https://github.com/WIP25-GB/ratingo-frontend#) or update your local repo if you already have it

6. Navigate to the front end repo and run the command below 
   ```
   
   ```



### 7.4 Create Launch Template

This defines how instances in the ASG will be launched.

1. Go to **EC2 > Launch Templates > Create launch template**.
2. **Name**: `ratingo-launch-template`
3. Select the AMI we created earlier: `ratingo-app-ami`.
4. Instance type: `t3.micro` (or your choice).
5. Security group: Select **`ratingo-asg-sg`**.
6. Save the launch template.

---

### 7.5 Create Auto Scaling Group (ASG)

1. Go to **EC2 > Auto Scaling Groups > Create Auto Scaling group**.
2. **Name**: `ratingo-asg`.
3. Choose the **Launch template** created earlier.
4. **VPC**: Select your VPC.
5. **Subnets**: Choose at least 2 subnets across different Availability Zones.
6. **Attach to a load balancer**:

   * Create a new Application Load Balancer:

     * Name: `ratingo-alb`
     * Internet-facing
     * Listeners: HTTP (80) and HTTPS (443)
     * Security group: `ratingo-lb-sg`
     * Target group: Create new target group, instance type.
   * Register ASG instances with this target group.
7. Set **Desired capacity**, **Min size**, and **Max size**.
8. Configure scaling policies (optional).
9. Create the ASG.

