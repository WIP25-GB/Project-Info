## ⚙️ Chapter 8: Auto Scaling Group (ASG) and Load Balancer (LB)

In this chapter, we will create the infrastructure to automatically scale our application using an Auto Scaling Group, fronted by an Application Load Balancer (ALB) to distribute incoming traffic. The ASG will launch EC2 instances from a custom AMI we create, and will only accept traffic from the Load Balancer.


### 8.1 Create Security Group for Load Balancer

This will allow public HTTP and HTTPS traffic.

1. Go to **EC2 > Security Groups > Create security group**.
2. **Name**: `ratingo-lb-sg`
3. **Inbound rules**:

   * Allow **HTTP (80)** from **0.0.0.0/0** (Anywhere).
   * Allow **HTTPS (443)** from **0.0.0.0/0** (Anywhere).
4. Click **Create**


### 8.2 Create Security Group for ASG Instances (Frontend)

We want the ASG instances to only accept traffic from the Load Balancer and Twingate.

1. Go to **EC2 > Security Groups > Create security group**.
2. **Name**: `ratingo-frontend-sg`
3. **Inbound rules**:

   * Allow **HTTP (80)** from the **Load Balancer security group** created in step **7.1**
   * Allow **SSH (22)** from the **twingate security group**
4. Click **Create**

### 8.3 Launch EC2 Instance for AMI Creation

We first create an EC2 instance where we’ll upload our application code, configure it, and create an AMI for the ASG.

1. **Log in** to the [AWS Management Console](https://console.aws.amazon.com/).

2. Go to **EC2 > Instances > Launch instances**.

3. **Name**: `ratingo-ami`

4. **AMI**: Select an appropriate OS (e.g., Ubuntu).

5. **Instance type**: Choose a suitable type (e.g., `t3.medium`).

6. Select the **Key pair** created in chapter 1

7. Click on the **Edit Button**  next the **Network Settings**
    * Select the **VPC** created in **chapter 1**
    * Choose any of the private subnets from the list
    * Choose **Select exisiting security group** and Attach the **asg security group** created in **step 7.2**

8. Launch the instance.


### 8.4 Add a resource for the instance to twingate

1. Login to twingate 

2. On the **Remote Network** tab, select your remote network

3. Click Create Resource

4. Provide a label eg `ami-instance`

5. Provide the **private ip address** of the instance in the address field. It should look like `10.0.0.123`

6. Grant access to this resource to Everyone, or if you have crated any groups, grant to the specific group


### 8.5 Connect and Configure the instance

1. On your terminal or visual studio code, locate where you have stored your private key from **chapter 1**

2. Run the command below to connect 
    ```
    ssh -i "ratingo-keypair.pem" ubuntu@10.0.1.123
    ```
    replacing **ratingo-keypair.pem** with your private key and **10.0.1.123** with the private ip of your instance

3. Run the command below to generate a keypair
    ```
    ssh-keygen -t rsa
    ```

    Hit enter until the key is generated

4. Copy the public key that was just generated by runnig the command
    ```
    cat ~/.ssh/id_rsa.pub
    ```

5. Go to github:
    * Click on your avatar on the top right corner of your screen
    * Click on settings
    * Click on SSH keys and GPG keys on the left panel
    * Click on **New SSH key**
    * Provide a **name** eg `ratingo-ami-instance`
    * Paste the public key into the **key** field
    * Click on **Add SSH**

8. Head back to your to your **ssh session** on your terminal or VScode and run the command below
    ```
    sudo mkdir /app && cd /app
    sudo chown -R ubuntu:ubuntu /app
    git clone git@github.com:WIP25-GB/ratingo-frontend.git
    sudo apt update
    sudo apt install -y nodejs npm nginx
    cd ratingo-frontend
    npm install
    sudo npm install -g pm2
    ```

    ```
    sudo rm /etc/nginx/sites-available/default
    sudo vi /etc/nginx/sites-available/default
    ```

    Hit `i` on the keyboard and make sure you see the word `insert` on the screen. Then paste the nginx site configuration below into the text editor

    ```
    server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name _;

        location / {
            proxy_pass http://localhost:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }

    ```

    Hit `esc` on your keyboard and make sure the word `insert` is gone. Then type `:wq!` and hit enter to save the configuration

    run the command below to reload nginx

    ```
    sudo systemctl reload nginx
    ```


### 8.6 Create an AMI from the instance

1. Go the the EC2 console

2. Find the instance just configured in **step 7.5**

3. Click on **Actions > Image and templates**

4. Click **Create an Image**

5. Give the **image(AMI)** a name eg `rating-frontend-ami`

6. Click on Create


### 8.7 Create an launch template aws & ASG

1. Go to **EC2 > Launch Templates > Create launch template**.

2. Provide a name eg `ratingo-frontend-template`

3. Under Application and OS Images (Amazon Machine Image), select the AMI we created on **step 7.6** `rating-frontend-ami`.

4. Instance type: `t3.micro` (or your choice).

5. Key pair: Same keypair we have always used

6. Security group: Select the seuciry group created in **step 7.2**

7. Expand the **Advanced details**. Look for **User data** and add the script below replacing the value of **REACT_APP_BACKEND_ENDPOINT** with the **endpoint** of your **api gateway** created in **chapter 6** and **REACT_APP_NOW_PLAYING_PATH, REACT_APP_TOP_RATED_PATH** with the paths configured in **api gateway**

    ```
    #!/bin/bash

    export REACT_APP_BACKEND_ENDPOINT="https://imbvdzogfi.execute-api.us-east-1.amazonaws.com"
    export REACT_APP_TOP_RATED_PATH="/rating" 
    export REACT_APP_NOW_PLAYING_PATH="/playing"

    cd /app/ratingo-frontend
    pm2 start npm --name "ratingo-frontend" -- start
    pm2 save
    ```

8. Save the launch template.

9. From the launch template just created, click on **Actions** > **Create Auto Scaling group**

10. Provide a name for your ASG eg `ratingo-frontend-asg`

11. For **Version**, select **latest**

12. Click on Next

13. **VPC**: Select your VPC from **chapter 1**.

14. Under **Availability Zones and subnets**: Choose all 3 private subnets.

15. Click on Next 2x

16. Set **Desired capacity: 2**, **Min size: 2**, and **Max size: 10**.

17. Configure scaling policies.
     * Select **Target tracking scaling policy**
     * Select **Average CPU Utilization** in the **Metric type** field
     * Leave the default values for **Target value** and **Instance warmup**

18. Click Next

19. Add a tag
    * Name: ratingo-frontend

20. Create the ASG.


### 8.8 Create a target group for the load balancer

1. Go to the EC2 console 

2. Select **Target Groups** from the left panel

3. Click **Create target group**

4. Choose a target type: **Instances**

5. Provide a target group name `ratingo-fronend-tg`

6. Leave the protocol **HTTP** **Port: 80**

7. Select the VPC from chapter 1

8. Click Next > Create target group


### 8.9 Create a load balancer with waf

1. Go to the EC2 console 

2. Select Load balancers from the left panel and click **Create load balancer**

3. Under **Application Load Balancer** click **Create**

4. Provide a name eg `ratingo-ext-lb`

5. **Scheme: Internet-facing**

6. Select the VPC created in chapter 1 under the Network mapping

7. Under **Availability Zones and subnets**, select the two **public subnets**

8. Select the security group created in **step 7.1**

9. Listeners and routing: 
    type: HTTPS
    action: forward -> to the target group created in **step 8.8**
    certificate: Select the ACM certificate issued in chapter 7


    type: HTTP
    action: redirect 
    uri: HTTPS
    port: 443

10. Check the box next to **AWS Web Application Firewall (WAF)**

11. Leave **Auto-create pre-defined WAF**

12. Click Create loadbalancer

13. Go back to the ASG created in **step 7.7**

14. Click on the **integration tab**

15. Under the **Load balancing**, click **Edit**

16. Check the **application load balancer** box and select the targer group created in **step 7.8**

17. Click on update
