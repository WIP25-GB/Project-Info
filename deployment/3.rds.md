## ⚙️ Chapter 2: RDS Instance

### 2.1 Create a Security Group
We create a secuirty group to allows us control what traffic is sent in and out of the valkey instance.

1. Log in to the [AWS Console](https://console.aws.amazon.com/).

2. Navigate to the **EC2** service.

3. In the left menu, click **Security Groups**.

4. Click **Create security group**.

5. Name the security group

    ```
    ratingo-rds-sg
    ```

    Add a description (optional), e.g.:

    ```
    Security group for ratingo rds instance
    ```

6. Add an inbound rule from twingate security group
    * Type: Custom TCP
    * Port range: 5432
    * Source: Custom
    * Select the twingate secuiry group
    * Save rule

7. Click **Create security group**

8. After creating a secuirty group for lambda in chapter 5, return to this secuiry group and add an inbound rule
    * Type: Custom TCP
    * Port range: 5432
    * Source: Custom
    * Select the secuiry group for lambda from the list
    * Save rule

### 2.2 Create Subnet Group

1. **Go to the RDS Console**:
   [https://console.aws.amazon.com/rds](https://console.aws.amazon.com/elasticache)

2. Click on **Subnet groups** on the left panel

3. Select Create DB subnet group

4. Provide a name eg `ratingo-private-subnet` and provide a description

5. Select the VPC created in chapter 1

6. **Add Subnets**
    * Choose us-east-1a, us-east-1b, us-east-1c 
    * Choose the private subnets from those 3 availability zone in the next field

7. Click Create


### 2.3 Create RDS Instance

We are create a managed PostgreSQL instance on AWS using Amazon RDS. This instance serves as our primary relational database to store movie ratings.

1. **Go to the RDS Console**:
   [https://console.aws.amazon.com/rds](https://console.aws.amazon.com/elasticache)

2. **Click**: **Create database**

3. For **Engine options**, choose **PostgreSQL**

4. For **Templates**, choose **Multi-AZ DB instance deployment (2 instances)**

5. Provide an **Instance identifier** eg `ratingo-db`

6. For **Credentials management**, select **Self managed** and check the **Auto generate password** box (RDS will generate a master password for you)

7. For **Master username**, provide a master user name eg `ratingo`

8. For **Instance configuration**, Select **Burstable classes (includes t classes)** and choose `db.t4g.micro` from the list

9. Keep the default storage type `gp3` and allocate 10GB of storage **Enable storage autoscaling** is checked

10. For **Virtual private cloud (VPC)**, select the VPC created in **chapter 1**

11. For **DB subnet group**, select the subnet group created in **step 2.2**

12. For **Existing VPC security groups**, select the security group created in **step 2.1**

13. Scroll down to **Additional configuration** and expand this option

14. For **Initial database name** add a database name eg `ratingo`. 

15. Keep **Backup** RDS will take snapshots of your database daily. This is important incase of loss of database instance

16. Ensure that **Enable encryption** is checked

17. Click **Create database**


### 2.4 Add a twingate resource for the RDS instance
1. Login to twingate 

2. On the **Remote Network** tab, select your remote network

3. Click Create Resource

4. Provide a label eg `ratingo-db`

5. Provide the **Endpoint of the RDS instance** in the address field eg `ratingo-db.cazcwami43fp.us-east-1.rds.amazonaws.com`

6. Grant access to this resource to Everyone, or if you have crated any groups, grant to the specific group



### 2.5 Run init SQL Script on the database
1. Download the database extension **Database Client JDBC** on your visual studio code

2. Click on the extenstion icon on the left panel and provide the connection details 
    * Provide a connection name eg `ratingo db`
    * Provide the endpoint of the database in the **Host** field eg `ratingo-db.cazcwami43fp.us-east-1.rds.amazonaws.com`
    * Provide the database name in **Database name** eg `ratingo`
    * Provide the master user name eg `ratingo` in the **Username** field
    * Keep the port at 5432
    * Toggle **SSL** on
    * Click connect

3. Expand the ratingo database from the list of databases

4. Click on on + next to **Query** to create a new query

5. Copy the content of the init.sql file located [here](https://github.com/WIP25-GB/Project-Info/tree/main/deployment/init.sql)

6. Run 3 queries. You will see the button to **run** just above **line 1**, **line 6** and **line 13**